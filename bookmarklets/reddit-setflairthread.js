javascript: (function() { app = { init: function() { if (!!$('.title-button.gold').length) { document.location = $('.title-button.gold').first().attr('href'); /* Redirect to 1500 comments */ return true; } app.setup.styles(); app.setup.dom(); app.setup.cleanup(); $('body').addClass('flair-initiliazed'); app.setup.expandComments(); }, setup: { styles: function() { if (!$('body').hasClass('flair-initiliazed')) { $('head').append('<style>' + '#flair_output {max-height: 80%; overflow-y: auto;text-align: center; padding:1em; position: fixed; min-width: 20%; min-height: 2em; background: #fff; box-shadow: 0 0 70px #000; left: 50%; top: 50%; transform: translate(-50%,-50%); z-index: 5;}' + '#siteTable + .commentarea .flair-winner {background: rgba(0,255,0,.5) !important;} ' + '#siteTable + .commentarea .flair-tie {background: rgba(255,180,0,.5) !important;} ' + '#siteTable + .commentarea .comment.dupe {outline: 3px solid rgba(255,0, 0,.5) !important;} ' + '#siteTable + .commentarea .comment.noflairs>.entry {outline: 3px solid rgba(0,255,0,.5) !important;}' + '</style>'); } }, dom: function() { if (!$('body').hasClass('flair-initiliazed')) { app.setup.cleanup(); $('body').click(function() { $('#flair_output').remove(); }); } if (!$('#flair_output').length) { $('body').append('<div id="flair_output"></div>'); $('#flair_output').click(function(e) { e.preventDefault(); e.stopImmediatePropagation(); }); } }, cleanup: function() { $('.comment.collapsed>.entry>.tagline>.expand').click(); /* Click all expand buttons */ $('.commentarea>.sitetable>.thing>.child .thing>.child').remove(); /* Remove third level comments */ $('.RESUserTag,.voteWeight,.expando-button.toggleImage,.usernote-button').remove(); /* Remove RES shit */ $('.thing.spam').remove(); /* Remove Moderated shit */ }, expandComments: function() { app.setup.cleanup(); if ($('.morecomments').length > 0) { app.output('Expanding comments: ' + $('.morecomments').length + ' links left to click'); evt = document.createEvent("MouseEvents"); evt.initMouseEvent("click", true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null); $('.morecomments a').first()[0].dispatchEvent(evt); app.setup.cleanup(); setTimeout(app.setup.expandComments, 200); } else { app.output(''); app.setup.cleanup(); app.process.prepStream(); } } }, output: function(str) { if (!$('#flair_output').length) { $('body').append('<div id="flair_output"></div>'); } $('#flair_output').html(str); }, validation: { noattempts: function() { $('.commentarea>.sitetable>.thing').each(function() { if ($(this).find('.child .tagline').length === 0) { $(this).addClass('noflairs'); } }); if ($('.noflairs').length !== 0) { alert('Some people are missing flairs'); } }, ties: function() { $('.thing.isTied').removeClass('isTied'); $('.commentarea>.sitetable>.thing').each(function() { topScore = -999; $(this).find('.child .tagline .score:visible').each(function() { thisScore = parseFloat($(this).text().replace(/\s+points?/g, '')); if (thisScore > topScore) { topScore = thisScore; $(this).closest('.thing').addClass('flair-winner').prevAll('.thing').removeClass('flair-winner flair-tie'); } else if (thisScore == topScore) { $(this).closest('.thing').addClass('flair-tie').prevAll('.thing').addClass('flair-tie').removeClass('flair-winner'); } }); }); $('.commentarea>.sitetable>.thing>.child .thing').each(function() { if (!($(this).hasClass('flair-tie') || $(this).hasClass('flair-winner'))) { $(this).hide(); } }); if ($('.flair-tie').length !== 0) { $('.flair-tie').parent().closest('.thing').addClass('isTied'); alert('There are ' + $('.thing.isTied').length + ' ties'); } }, dupes: function() { $('.comment.dupe').removeClass('dupe'); $('.commentarea>.sitetable>.thing>.entry>.tagline .author').each(function() { $(this).addClass('user-' + $(this).text()); }); $('.commentarea>.sitetable>.thing>.entry>.tagline .author').each(function() { var user = $(this).text(); if ($('.user-' + user).length > 1) { $(this).closest('.comment').addClass('dupe'); console.log('dupe for ' + user); } }); if ($('.comment.dupe').length > 0) { alert('Some people requested flair more than once'); } } }, process: { prepStream: function() { app.process.data = {}; app.process.attempts.sortem(); app.setup.cleanup(); $('.flair-tie,.flair-winner,.noflairs').removeClass('flair-tie flair-winner noflairs'); app.validation.noattempts(); app.validation.ties(); app.validation.dupes(); app.finalize = confirm('Would you like to set flairs?'); app.process.attempts.get(); if (app.finalize === true) { app.process.submit.init(); } else { app.process.showOutput(); } }, attempts: { sortem: function() { $('.commentarea > .sitetable > .thing > .child > .sitetable').each(function() { el = $(this); el.children('.thing').each(function() { $(this).attr('data-score', $(this).find('.score:visible').text().replace(/[^\d-]/g, '')); if ($(this).hasClass('flair-tie') && !!$(this).find('.upmod').length) { $(this).find('.score:visible').text(parseFloat($(this).attr('data-score')) + 1); } }); el.children('.spam').each(function() { $(this).find('.score:visible').text('-100'); }); }); }, get: function() { $('.commentarea > .sitetable > .thing ').each(function() { el = $(this).find('> .child > .sitetable'); request_el = el.closest('.thing'); requestee = request_el.hasClass('deleted') ? '' : request_el.find('.author').first().text(); app.process.data[requestee] = app.process.data[requestee] || {}; app.process.data[requestee]['responses'] = app.process.data[requestee]['responses'] || 0; app.process.data[requestee]['responses'] += el.children('.thing').length; el.children('.thing').each(function(i) { attemptee = $(this).hasClass('deleted') ? '' : $(this).find('.author').first().text(); flairText = $(this).find('.usertext-body .md p').first().text(); if (flairText.match(/\[.*\]/) && !$(this).hasClass('deleted')) { app.process.data[attemptee] = app.process.data[attemptee] || {}; app.process.data[attemptee]['attempts'] = !app.process.data[attemptee].hasOwnProperty('attempts') ? 1 : app.process.data[attemptee]['attempts'] + 1; if ($(this).hasClass('flair-winner')) { app.process.data[requestee]['flairText'] = flairText; app.process.data[requestee]['flairClass'] = !!request_el.find('.flair').length ? request_el.find('.flair').attr('class').replace('flair ', '') : ''; app.process.data[requestee]['flairLink'] = '/r/CenturyClub/comments/' + $('#siteTable .thing').first().attr('id').replace(/.*_/, '') + '/-/' + $(this).attr('id').replace(/.*_/, '') + '?context=1'; app.process.data[requestee]['requests'] = app.process.data[requestee]['requests'] + 1 || 1; app.process.data[attemptee]['successes'] = !app.process.data[attemptee].hasOwnProperty('successes') ? 1 : app.process.data[attemptee]['successes'] + 1; app.process.data[attemptee]['permalinks'] = app.process.data[attemptee]['permalinks'] || ''; app.process.data[attemptee]['permalinks'] += '[[' + app.process.data[attemptee]['successes'] + ']](/r/CenturyClub/comments/' + $('#siteTable .thing').first().attr('id').replace(/.*_/, '') + '/-/' + $(this).attr('id').replace(/.*_/, '') + '?context=1) '; } } }); }); } }, submit: { init: function() { my_hash = r.config.modhash; this_subreddit = r.config.cur_listing; app.process.toSubmit = []; for (key in app.process.data) { item = app.process.data[key]; if (item['flairText']) { item.target = key; app.process.toSubmit.push(item); } } app.process.submit.next(); }, next: function() { if (app.process.toSubmit.length > 0) { item = app.process.toSubmit[0]; $('#flair_output').text('Setting flair for ' + item['target']); $.ajax({ url: '/api/flair', data: { name: item['target'], text: item['flairText'], css_class: item['flairClass'], id: '#flair-xxxxx', r: this_subreddit, uh: my_hash, renderstyle: 'html' }, method: 'POST' }).then(function() { $('#flair_output').text('Successfully set flair for ' + app.process.toSubmit[0]['target']); app.process.toSubmit.shift(); app.process.submit.next(); }, function() { app.process.submit.next(); }); } else { app.process.showOutput(); } } }, showOutput: function() { $('#flair_output').text(''); sortable = []; str = '#Inside the Flair Thread\n\n***Here\'s the breakdown:***\n\nUser|Responses|Successful Flairs|Attempted Flairs|Weighted Successes|Success Permalinks\n:--|--:|--:|--:|--:|:--\n'; for (key in app.process.data) { item = app.process.data[key]; item['successes'] = item['successes'] || 0; sortable.push({ name: key.replace(/\_/g, '\\_'), responses: item['responses'], requests: item['requests'], flairLink: item['flairLink'], successes: item['attempts'] ? item['successes'] : '-', attempts: item['attempts'] ? item['attempts'] : '-', weighted: item['attempts'] ? (item['successes'] * (item['successes'] / item['attempts'])).toFixed(2) : -4000, permalinks: item['attempts'] ? item['permalinks'] : 'moocher', }); } sortable = sortable.sort(function(a, b) { return parseFloat(a.weighted) > parseFloat(b.weighted) ? -1 : parseFloat(a.weighted) < parseFloat(b.weighted) ? 1 : a.successes > b.successes ? 1 : a.successes < b.successes ? -1 : a.attempts > b.attempts ? 1 : a.attempts < b.attempts ? -1 : a.name.toLowerCase() > b.name.toLowerCase() ? 1 : a.name.toLowerCase() < b.name.toLowerCase() ? -1 : 0; }); count = 0; attempts = 0; for (i = 0; i < sortable.length; i++) { item = sortable[i]; str += (item['name'] === '' ? '[deleted]' : item['flairLink'] ? '[' + item['name'] + '](' + item['flairLink'] + ')' : item['name']) + (item['requests'] > 1 ? ' x' + item['requests'] : '') + '|' + (item['responses'] || '') + '|' + item['successes'] + '|' + item['attempts'] + '|' + (item['permalinks'] === 'moocher' ? '-' : item['weighted']) + '|' + (item['permalinks'] || '') + '\n'; if (item['permalinks'] !== 'moocher') { count += item['successes']; attempts += item['attempts']; } } str += ' | |' + count + '|' + attempts + '| | | \n\n'; str += '---\n\n [Here\'s a link to the flair thread](/r/CenturyClub/comments/' + $('#siteTable .thing').first().attr('id').replace(/.*_/, '') + ')'; $('#flair_output').append('<textarea style="width:100%;">' + str + '</textarea>'); console.log('done'); } } }; app.init(); })();